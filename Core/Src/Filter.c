#include "Filter.h"
#include "arm_math.h"
#include "fir.h"
#include "iir.h"
#include "math.h"
#include "stdio.h"

//低通FIR 截止频率1k~20kHz 步进1k
const float LowPassFIR[20][LPFIR_ORDER] = {
  {
   0.001097916347537, 0.001107652655043, 0.001132635333579, 0.001172893706039,
   0.001228417360963, 0.001299156044723, 0.001385019660456, 0.001485878374041,
   0.001601562827146, 0.001731864457057, 0.001876535922702, 0.002035291635995,
   0.002207808397328, 0.002393726133739, 0.002592648738006, 0.002804145006612,
   0.003027749674288,  0.00326296454251, 0.003509259699106, 0.003766074825855,
   0.004032820590695, 0.004308880120941, 0.004593610553653, 0.004886344659106,
   0.005186392533061, 0.005493043353381, 0.005805567196323, 0.006123216907653,
   0.006445230023615,  0.00677083073658, 0.007099231900118, 0.007429637068088,
   0.007761242562255, 0.008093239562833, 0.008424816216321, 0.008755159754896,
   0.009083458621623, 0.009408904595698, 0.009730694911942,  0.01004803436877,
    0.01036013741886,  0.01066623023689,  0.01096555275856,  0.01125736068543,
    0.01154092745004,  0.01181554613592,  0.01208053134725,  0.01233522102295,
    0.01257897819039,  0.01281119265366,  0.01303128261203,  0.01323869620387,
    0.01343291297199,  0.01361344524625,  0.01377983943969,  0.01393167725457,
    0.01406857679494,  0.01419019358287,  0.01429622147524,  0.01438639347887,
    0.01446048246143,  0.01451830175647,  0.01455970566066,  0.01458458982199,
    0.01459289151781,  0.01458458982199,  0.01455970566066,  0.01451830175647,
    0.01446048246143,  0.01438639347887,  0.01429622147524,  0.01419019358287,
    0.01406857679494,  0.01393167725457,  0.01377983943969,  0.01361344524625,
    0.01343291297199,  0.01323869620387,  0.01303128261203,  0.01281119265366,
    0.01257897819039,  0.01233522102295,  0.01208053134725,  0.01181554613592,
    0.01154092745004,  0.01125736068543,  0.01096555275856,  0.01066623023689,
    0.01036013741886,  0.01004803436877, 0.009730694911942, 0.009408904595698,
   0.009083458621623, 0.008755159754896, 0.008424816216321, 0.008093239562833,
   0.007761242562255, 0.007429637068088, 0.007099231900118,  0.00677083073658,
   0.006445230023615, 0.006123216907653, 0.005805567196323, 0.005493043353381,
   0.005186392533061, 0.004886344659106, 0.004593610553653, 0.004308880120941,
   0.004032820590695, 0.003766074825855, 0.003509259699106,  0.00326296454251,
   0.003027749674288, 0.002804145006612, 0.002592648738006, 0.002393726133739,
   0.002207808397328, 0.002035291635995, 0.001876535922702, 0.001731864457057,
   0.001601562827146, 0.001485878374041, 0.001385019660456, 0.001299156044723,
   0.001228417360963, 0.001172893706039, 0.001132635333579, 0.001107652655043,
   0.001097916347537
  },
  
  {
  -0.0003665099638286,-0.0003869113802631,-0.0004111346194867,-0.000439527272537,
  -0.0004722367827581,-0.0005091914257645,-0.0005500844293861,-0.000594361581646,
  -0.0006412126286976,-0.000689566713213,-0.0007380920476654,-0.000785199957044,
  -0.0008290533626238,-0.0008675797133631,-0.0008984883052498,-0.0009192918624228,
  -0.0009273321881215,-0.0009198096294383,-0.0008938160384272,-0.0008463708542675,
  -0.0007744598778076,-0.0006750762617175,-0.0005452631974556,-0.0003821577449555,
  -0.0001830352229826, 5.46464420339e-05,0.0003332030228196, 0.000654681571308,
   0.001020819884344, 0.001433008453626, 0.001892255476103, 0.002399155470293,
   0.002953862005287, 0.003556065002915, 0.004204973020291,   0.0048993008604,
   0.005637262793292, 0.006416571600616, 0.007234443582729, 0.008087609591179,
   0.008972332071351, 0.009884428021193,  0.01081929769359,  0.01177195879299,
    0.01273708584249,  0.01370905432683,  0.01468198915037,  0.01564981688856,
    0.01660632125699,  0.01754520117479,   0.0184601307601,  0.01934482056416,
    0.02019307932872,  0.02099887553852,  0.02175639803766,  0.02246011498443,
    0.02310483043542,  0.02368573787452,  0.02419847003667,  0.02463914441909,
     0.0250044039232,  0.02529145212922,  0.02549808276954,  0.02562270303839,
    0.02566435045016,  0.02562270303839,  0.02549808276954,  0.02529145212922,
     0.0250044039232,  0.02463914441909,  0.02419847003667,  0.02368573787452,
    0.02310483043542,  0.02246011498443,  0.02175639803766,  0.02099887553852,
    0.02019307932872,  0.01934482056416,   0.0184601307601,  0.01754520117479,
    0.01660632125699,  0.01564981688856,  0.01468198915037,  0.01370905432683,
    0.01273708584249,  0.01177195879299,  0.01081929769359, 0.009884428021193,
   0.008972332071351, 0.008087609591179, 0.007234443582729, 0.006416571600616,
   0.005637262793292,   0.0048993008604, 0.004204973020291, 0.003556065002915,
   0.002953862005287, 0.002399155470293, 0.001892255476103, 0.001433008453626,
   0.001020819884344, 0.000654681571308,0.0003332030228196, 5.46464420339e-05,
  -0.0001830352229826,-0.0003821577449555,-0.0005452631974556,-0.0006750762617175,
  -0.0007744598778076,-0.0008463708542675,-0.0008938160384272,-0.0009198096294383,
  -0.0009273321881215,-0.0009192918624228,-0.0008984883052498,-0.0008675797133631,
  -0.0008290533626238,-0.000785199957044,-0.0007380920476654,-0.000689566713213,
  -0.0006412126286976,-0.000594361581646,-0.0005500844293861,-0.0005091914257645,
  -0.0004722367827581,-0.000439527272537,-0.0004111346194867,-0.0003869113802631,
  -0.0003665099638286
  
  
  }
  ,
  {
  0.0003239533026213,0.0003027982289421,0.0002803775236634,0.0002554401537758,
  0.0002264529837782,0.0001916536235155,0.0001491155193971,9.682391535791e-05,
  3.276096618563e-05,-4.500202311382e-05,-0.0001382075239527,-0.0002483123837736,
  -0.0003763887633063,-0.0005230281714282,-0.000688251386699,-0.0008714270153462,
  -0.001071201327147,-0.001285441834289,-0.001511196836581, -0.00174467285353,
  -0.001981231505712,-0.002215407001615,-0.002440944940312,-0.002650862664467,
  -0.002837530902704,-0.002992775936441,-0.003108001025325,-0.003174325339092,
  -0.003182738183498,-0.003124265885007,-0.002990148323609,-0.002772021785046,
  -0.002462104551181,-0.002053381467238,-0.001539783622815,-0.0009163592635493,
  -0.0001794321142657,0.0006732565574644, 0.001642425577983, 0.002727154335697,
   0.003924808829173, 0.005230995594412, 0.006639545303505, 0.008142527272122,
   0.009730295521971,  0.01139156642862,  0.01311352735775,  0.01488197506726,
    0.01668148204172,  0.01849558834326,  0.02030701602069,  0.02209790262973,
    0.02385004999099,  0.02554518396009,  0.02716522071235,  0.02869253486076,
    0.03011022463418,   0.0314023693455,  0.03255427447818,  0.03355269991167,
    0.03438606708938,  0.03504464130085,  0.03552068569576,  0.03580858416282,
    0.03590493077987,  0.03580858416282,  0.03552068569576,  0.03504464130085,
    0.03438606708938,  0.03355269991167,  0.03255427447818,   0.0314023693455,
    0.03011022463418,  0.02869253486076,  0.02716522071235,  0.02554518396009,
    0.02385004999099,  0.02209790262973,  0.02030701602069,  0.01849558834326,
    0.01668148204172,  0.01488197506726,  0.01311352735775,  0.01139156642862,
   0.009730295521971, 0.008142527272122, 0.006639545303505, 0.005230995594412,
   0.003924808829173, 0.002727154335697, 0.001642425577983,0.0006732565574644,
  -0.0001794321142657,-0.0009163592635493,-0.001539783622815,-0.002053381467238,
  -0.002462104551181,-0.002772021785046,-0.002990148323609,-0.003124265885007,
  -0.003182738183498,-0.003174325339092,-0.003108001025325,-0.002992775936441,
  -0.002837530902704,-0.002650862664467,-0.002440944940312,-0.002215407001615,
  -0.001981231505712, -0.00174467285353,-0.001511196836581,-0.001285441834289,
  -0.001071201327147,-0.0008714270153462,-0.000688251386699,-0.0005230281714282,
  -0.0003763887633063,-0.0002483123837736,-0.0001382075239527,-4.500202311382e-05,
  3.276096618563e-05,9.682391535791e-05,0.0001491155193971,0.0001916536235155,
  0.0002264529837782,0.0002554401537758,0.0002803775236634,0.0003027982289421,
  0.0003239533026213
  }
  ,
  {
  6.950641838888e-05,0.0001279554069383,0.0001888984883359,0.0002533520442488,
  0.0003220136321379,0.0003951187385561,0.0004723129139874,0.0005525466977265,
  0.0006340001218788, 0.000714042669427,0.0007892333778422,0.0008553643628286,
  0.0009075494318738,0.0009403577177515,0.0009479904477865,0.0009244971396463,
  0.0008640257450045,0.0007610996148191, 0.000610912697981,0.0004096331677564,
   0.000154704749952,-0.0001548655536324,-0.0005182448604002,-0.0009325482486001,
  -0.001392659785592,-0.001891110499508,-0.002418021691169,-0.002961120279393,
   -0.00350583087028, -0.00403544699623, -0.00453138154921, -0.00497349390892,
  -0.005340488718943,-0.005610378774723,-0.005761002138247,-0.005770581465482,
  -0.005618311698225,-0.005284960799153,-0.004753467154223,-0.004009516675134,
   -0.00304208253745,-0.001843910903432,-0.0004119369031437, 0.001252383432617,
   0.003142837709765, 0.005248328298973, 0.007552857514952,  0.01003563136278,
    0.01267128321947,  0.01543021555853,  0.01827905454664,  0.02118120914234,
    0.02409752330114,  0.02698700713364,  0.02980763045569,  0.03251716018974,
    0.03507402158588,   0.0374381622804,  0.03957189783124,  0.04144071758101,
    0.04301403049832,  0.04426583201798,  0.04517527480609,  0.04572712876394,
    0.04591211839011,  0.04572712876394,  0.04517527480609,  0.04426583201798,
    0.04301403049832,  0.04144071758101,  0.03957189783124,   0.0374381622804,
    0.03507402158588,  0.03251716018974,  0.02980763045569,  0.02698700713364,
    0.02409752330114,  0.02118120914234,  0.01827905454664,  0.01543021555853,
    0.01267128321947,  0.01003563136278, 0.007552857514952, 0.005248328298973,
   0.003142837709765, 0.001252383432617,-0.0004119369031437,-0.001843910903432,
   -0.00304208253745,-0.004009516675134,-0.004753467154223,-0.005284960799153,
  -0.005618311698225,-0.005770581465482,-0.005761002138247,-0.005610378774723,
  -0.005340488718943, -0.00497349390892, -0.00453138154921, -0.00403544699623,
   -0.00350583087028,-0.002961120279393,-0.002418021691169,-0.001891110499508,
  -0.001392659785592,-0.0009325482486001,-0.0005182448604002,-0.0001548655536324,
   0.000154704749952,0.0004096331677564, 0.000610912697981,0.0007610996148191,
  0.0008640257450045,0.0009244971396463,0.0009479904477865,0.0009403577177515,
  0.0009075494318738,0.0008553643628286,0.0007892333778422, 0.000714042669427,
  0.0006340001218788,0.0005525466977265,0.0004723129139874,0.0003951187385561,
  0.0003220136321379,0.0002533520442488,0.0001888984883359,0.0001279554069383,
  6.950641838888e-05
  },
  {
 -0.0003845602662728,-0.0004059008893286,-0.0004209518894332,-0.0004285832398479,
  -0.0004269452936351,-0.0004135331212252,-0.0003853269113049,-0.0003390045278739,
  -0.0002712173954203,-0.0001789162262211,-5.970897401294e-05,8.776995639054e-05,
  0.0002635025780239,0.0004657668048544,0.0006908770036558,0.0009330086478311,
   0.001184127351646, 0.001434038550113, 0.001670568958681,   0.0018798848999,
   0.002046945876848, 0.002156084703715, 0.002191698401123,  0.00213902727125,
   0.001984993429037, 0.001719064907182, 0.001334107568086,0.0008271846916643,
  0.0002002634495119,-0.0005392113623335,-0.001377912942429,-0.002296429239808,
  -0.003269286129608,-0.004265214323837,-0.005247668184654,-0.006175594626374,
  -0.007004439874895, -0.00768737142901,-0.008176682581875,-0.008425337753373,
  -0.008388609072444, -0.00802574850766, -0.00730163568975,-0.006188339642221,
  -0.004666533089647, -0.00272670090596,-0.000370089555636, 0.002390648073243,
   0.005531148482369,  0.00901539880946,  0.01279617575672,  0.01681586109364,
    0.02100761895676,  0.02529690671703,  0.02960327848242,  0.03384242885797,
    0.03792841486573,  0.04177598633687,  0.04530294995329,  0.04843248966734,
      0.051095366593,  0.05323192465691,  0.05479383422768,  0.05574551440348,
    0.05606518532533,  0.05574551440348,  0.05479383422768,  0.05323192465691,
      0.051095366593,  0.04843248966734,  0.04530294995329,  0.04177598633687,
    0.03792841486573,  0.03384242885797,  0.02960327848242,  0.02529690671703,
    0.02100761895676,  0.01681586109364,  0.01279617575672,  0.00901539880946,
   0.005531148482369, 0.002390648073243,-0.000370089555636, -0.00272670090596,
  -0.004666533089647,-0.006188339642221, -0.00730163568975, -0.00802574850766,
  -0.008388609072444,-0.008425337753373,-0.008176682581875, -0.00768737142901,
  -0.007004439874895,-0.006175594626374,-0.005247668184654,-0.004265214323837,
  -0.003269286129608,-0.002296429239808,-0.001377912942429,-0.0005392113623335,
  0.0002002634495119,0.0008271846916643, 0.001334107568086, 0.001719064907182,
   0.001984993429037,  0.00213902727125, 0.002191698401123, 0.002156084703715,
   0.002046945876848,   0.0018798848999, 0.001670568958681, 0.001434038550113,
   0.001184127351646,0.0009330086478311,0.0006908770036558,0.0004657668048544,
  0.0002635025780239,8.776995639054e-05,-5.970897401294e-05,-0.0001789162262211,
  -0.0002712173954203,-0.0003390045278739,-0.0003853269113049,-0.0004135331212252,
  -0.0004269452936351,-0.0004285832398479,-0.0004209518894332,-0.0004059008893286,
  -0.0003845602662728
}
  };
/*  DDS输出  */
SinWave sinwave;

#define FFT_SIZE LENGTH_SAMPLES  		//做FFT的点数

#define isDebug 0  		//调试模式
static float FFT_Buffer[FFT_SIZE];

		/**********FIR滤波器**********/
		
static float FIR_State[BLOCK_SIZE_FIR+FIR_ORDER] ;   //FIR滤波器状态缓存
static arm_fir_instance_f32 FIR_Sta; //定义结构体S

void calc_FIR_noW(float*input,float*para)  //普遍使用的FIR，每次处理BLOCK_SIZE_FIR个点
	
{
    float FIR_State[BLOCK_SIZE_FIR+FIR_ORDER] ;   //FIR滤波器状态缓存
    arm_fir_instance_f32 FIR_Sta; //定义结构体S
    arm_fir_init_f32(&FIR_Sta, FIR_LEN, (float*)para, FIR_State, BLOCK_SIZE_FIR); //初始化结构体
    for(u16 i=0;i<NUMBLOCKS_FIR;i++)
    {
        arm_fir_f32(&FIR_Sta, input + (i * BLOCK_SIZE_FIR), input + (i * BLOCK_SIZE_FIR),BLOCK_SIZE_FIR);
    }
	
}


void calc_FIR(float *input,u16 w) //可控制截止频率的FIR
{
    arm_fir_init_f32(&FIR_Sta, FIR_LEN, (float*)LowPassFIR[w-1], FIR_State, BLOCK_SIZE_FIR); //初始化结构体
    for(u16 i=0;i<LENGTH_SAMPLES;i++)
    {
        arm_fir_f32(&FIR_Sta, input + (i * BLOCK_SIZE_FIR), input + (i * BLOCK_SIZE_FIR),BLOCK_SIZE_FIR);
    }
	#if isDebug
	for(int j=0;j<LENGTH_SAMPLES;j++)
		printf("%f\r\n",input[j]);
	#endif
}

 
		/***********IIR滤波器**********/

/*
IIR的过渡带可以做的很窄,但是由于数据放缩的特性,
且F4系列最多支持float型DSP算法,直接导致IIR滤波器
阶数最多6阶左右,且反馈时间长且不稳定,因此一般选择FIR滤波器
*/
static float IIR_State[4*IIR_ORDER];//IIR滤波器状态缓存 
static arm_biquad_casd_df1_inst_f32 IIR_Sta;
void calc_IIR(float *Input,float* Output)
{
    arm_biquad_cascade_df1_init_f32(&IIR_Sta, IIR_ORDER, iir_params, IIR_State); //初始化结构体S 
    /* IIR滤波 */
	for(int i=0;i<NUMBLOCKS_IIR;i++)
	arm_biquad_cascade_df1_f32(&IIR_Sta,Input+(i * BLOCK_SIZE_IIR),Output + (i * BLOCK_SIZE_IIR),BLOCK_SIZE_IIR);
    //arm_scale_f32(Output,ScaleValue,Output,IIR_length); //数据放缩
	#if isDebug
	for(int j=0;j<LENGTH_SAMPLES;j++)
		printf("%f\r\n",Output[j]*ScaleValue);
	#endif
}

		/**********FFT运算**********/

void calc_FFT(float*Input,float*Output)
{   
    //FIR_calc(Input);
    arm_rfft_fast_instance_f32 S;//结构体
    arm_rfft_fast_init_f32(&S,FFT_SIZE);//初始化该结构体
    arm_rfft_fast_f32(&S, Input, FFT_Buffer, 0);//ifft_flag=0是正变换， 为1则是逆变换
    arm_cmplx_mag_f32(FFT_Buffer, Output, FFT_SIZE);  //求幅值
    arm_scale_f32(Output,2.0f/FFT_SIZE,Output,FFT_SIZE);    //换算成真实V   模值 = (A*2)/采样点数
    Output[0] *= 0.5f;//直流转换成真实电压
	#if isDebug
	for(int i=0;i<LENGTH_SAMPLES;i++)
		printf("%f\r\n",Output[i]);
	#endif
}

		/**********求相位**********/
/* 形 参：	_usFFTPoints 复数个数，每个复数是两个float32_t数值*/
/* 			_uiCmpValue 比较值，需要求出相位的数值			*/
void PowerPhaseRadians_f32(float* Input_f32,float Phase_f32,uint16_t _usFFTPoints, float _uiCmpValue)
{}


		/**********hanning窗**********/

void hanning_window(float * pDst,u32 blockSize)
{
   float k = 2.0f / ((float) blockSize);
   float w;

   for(u32 i=0;i<blockSize;i++)
   {
     w = PI * i * k;
     w = 0.5f * (1.0f - cosf (w));
     pDst[i] = w;
	 #if isDebug
	  printf("%f\r\n",pDst[i]);
	 #endif
   }
}

		/**********归一化hamming窗**********/
/*@param
@blockSize:窗的长度
@pDst: 长度为blocksize的hanmming窗
*/
void hamming_window(float * pDst,u32 blockSize)
{
   float k = 2.0f / ((float) blockSize);
   float w;

   for(u32 i=0;i<blockSize;i++)
   {
     w = 0.54f - 0.46f * cosf (PI * i * k);
     pDst[i] = w;
	 #if isDebug
	   for(int i=0;i<blocksize;i++)
			printf("%f\r\n",pDst[i]);
	 #endif
   }
}

		/**********归一化blackman窗**********/
/*@param
@blockSize:窗的长度
@pDst: 长度为blocksize的blackman窗
*/
void blackman_window(float * pDst,u32 blockSize)
{
   float32_t k = 2.0f / ((float32_t) blockSize);
   float32_t w;

   for(uint32_t i=0;i<blockSize;i++)
   {
     w = PI * i * k;
        w = 0.35875f - 0.48829f * cosf (w) +
			0.14128f * cosf (2.f * w) - 0.01168f * cosf (3.f * w);
         pDst[i] = w;
	  #if isDebug
	   for(int i=0;i<blocksize;i++)
			printf("%f\r\n",pDst[i]);
	 #endif
   }
}

/*求最大值*/

